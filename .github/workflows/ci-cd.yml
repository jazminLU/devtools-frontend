name: Frontend CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      build_image:
        description: 'Build and push Docker image'
        required: false
        default: 'true'
        type: boolean
      deploy_dev:
        description: 'Deploy to dev cluster'
        required: false
        default: 'false'
        type: boolean

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 558497223978
  ECR_REGISTRY: 558497223978.dkr.ecr.us-east-1.amazonaws.com
  IMAGE_REPO: moon-frontend
  HELM_CHART_REPO: devtools-playground
  HELM_CHART_NAME: devtools-playground-frontend
  EKS_CLUSTER_NAME: moon-dev-eks
  SONAR_ORG: jazminlu-moon
  SONAR_PROJECT_KEY: jazminLU_devtools-frontend
  AWS_ROLE_ARN: arn:aws:iam::558497223978:role/github-actions-devtools-frontend

jobs:
  lint-and-test:
    uses: ./.github/workflows/template-lint-and-test.yml
    with:
      node_version: '18'

  sonarcloud-analysis:
    needs: lint-and-test
    permissions:
      contents: read
      pull-requests: write
    uses: ./.github/workflows/template-sonarcloud-analysis.yml
    with:
      node_version: '18'
      sonar_org: jazminlu-moon
      sonar_project_key: jazminLU_devtools-frontend
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    continue-on-error: true

  build-and-push:
    needs: lint-and-test
    permissions:
      id-token: write
      contents: read
    uses: ./.github/workflows/template-build-and-push.yml
    with:
      aws_region: us-east-1
      ecr_registry: 558497223978.dkr.ecr.us-east-1.amazonaws.com
      image_repo: moon-frontend
      aws_role_arn: arn:aws:iam::558497223978:role/github-actions-devtools-frontend
      dockerfile_path: './Dockerfile'
      context_path: '.'
      vite_api_url: '/api'
    secrets:
      AWS_ROLE_SESSION_NAME: 'GitHubActions-Frontend-Build'

  deploy-dev:
    needs: build-and-push
    if: success()
    permissions:
      id-token: write
      contents: read
    uses: ./.github/workflows/template-deploy-dev.yml
    with:
      aws_region: us-east-1
      ecr_registry: 558497223978.dkr.ecr.us-east-1.amazonaws.com
      image_repo: moon-frontend
      eks_cluster_name: moon-dev-eks
      helm_chart_repo: devtools-playground
      helm_chart_name: devtools-playground-frontend
      helm_chart_version: '1.0.0'
      namespace: 'devtools-playground'
      values_file: 'helm/values-moon-dev.yaml'
      aws_role_arn: arn:aws:iam::558497223978:role/github-actions-devtools-frontend
      helm_version: '3.13.0'
      application_url: 'https://app.infra-moon.com'
    secrets:
      AWS_ROLE_SESSION_NAME: 'GitHubActions-Frontend-Deploy'
